# End Effector 2023
## Device Overview
  End Effector เป็นอุปกรณ์ที่ทำหน้าที่เสมือน Gripper อย่างง่าย โดยใช้การติดต่อสื่อสารผ่าน I2C และแสดงผลการจำลองการทำงานของ Gripper ผ่าน Laser และ LED แสดงสถานะการทำงาน โดยใช้ติดตั้งบนหุ่นยนต์หรือแขนกลเพื่อใช้ในการจำลองการหยิบจับชิ้นงาน
  
  ระบบจะจำลองการทำงานของ Gripper แบบ Remote ผ่าน I2C โดย Gripper จำลองดังกล่าวจะสามารถปิดเปิดการทำงานของ Gripper ได้เพื่อประหยัดพลังงาน และเมื่อเปิดการทำงานแล้วจะสามารถจำลองการหยิบจับและวางสิ่งของได้โดยมีการจำลองระยะเวลาที่ใช้ในการหยิบขึ้นหรือวางลงด้วย
 
 โดยระบบ End Effector สามารถเข้าสู่ Test mode เพื่อเปิดการทำงานของ Laser ค้างเอาไว้เพื่อใช้ในการกำหนดตำแหน่งต่างๆ ได้
  และมี Emergency Mode ซึ่งจะหยุดการทำงานปัจจุบันและ Lock ระบบเพื่อจำลองความปลอดภัยให้แก่ผู้ใช้
  

    
## Device Information

![image](https://github.com/AlphaP2712/EndEffector2023/assets/74948675/2fe9dd6f-3201-4b53-ba1f-152b3bb64051)


ในส่วนของ End Effector จะแสดงสถานะการทำงานโดยใช้สัญญาณไฟ LED โดยมีการแสดงผลดังต่อไปนี้

### ไฟแสดงสถานะ POW
  POW แสดงสถานะการได้รับไฟเลี้ยงของ End Effector โดยทั่วไปแล้วควรติดตลอดเวลาที่จ่ายไฟ แต่มีโอกาสที่จะติดโดยที่ไม่ได้จ่ายไฟได้จากการรั่วไหลของไฟฟ้าตาม IO ต่างๆ เช่น I2C ในกรณีนั้นอาจจะส่งผลให้ระบบทำงานผิดพลาดได้
| LED POW | คำอธิบาย|
|-------|--------|
| ติด | ระบบได้รับไฟเลี้ยงสำหรับการทำงาน |
| ดับ | ระบบไม่ได้รับไฟเลี้ยงสำหรับการทำงาน  |



### ไฟแสดงสถานะ L 
  L แสดงถึงสถานะการทำงานโดยรวมของ End Effector โดยใช้การกระพริบในการสื่อสารสถานะปัจจุบัน L จะกระพริบอยู่เสมอเพื่อเป็นการบอกว่าโปรแกรมภายใน End Effector ยังคงทำงานอยู่ หาก L หยุดการเปลี่ยนแปลง เช่น ติดค้างหรือดับค้าง แสดงถึงข้อผิดพลาดอย่างร้ายแรงในระบบซึ่งส่งผลให้ระบบ End Effector ค้าง
| LED L | คำอธิบาย|
|-------|--------|
| ติดกระพริบอย่างต่อเนื่องช้าๆ ด้วยความถี่ประมาณ 1 Hz | ระบบกำลังเริ่มการทำงาน |
| ติดสั้นๆ 1 ครั้ง เป็นช่วงๆ | ระบบพร้อมทำงาน / สถานะการทำงานปกติ |
| ติดสั้นๆ 2 ครั้ง เป็นช่วงๆ | อยู่ใน TEST MODE |
| กระพริบอย่างรวดเร็ว ด้วยความถี่สูงประมาณ 2 Hz | ระบบอยู่ใน Emergency Mode |
| ติดค้าง / ดับค้าง | ระบบมีข้อผิดพลาดอย่างร้ายแรง กรุณาติดต่อพี่ปั้น  |


### ไฟแสดงสถานะ D1
  D1 แสดงสถานะการเปิด - ปิดการทำงานของ Gripper
| LED D1 | คำอธิบาย|
|-------|--------|
| ติด | Gripper ได้เปิดระบบการทำงานและพร้อมที่จะหยิบ / วางชิ้นงาน |
| ดับ | Gripper อยู่ในสถานะปิดการทำงาน  |

### ไฟแสดงสถานะ D2
  D2 แสดงสถานะการหยิบ / วางของ Gripper
| LED D2 | คำอธิบาย|
|-------|--------|
| ติด | Gripper กำลังจับชิ้นงานเอาไว้|
| ดับ | Gripper ไม่ได้จับชิ้นงานใดๆ  |
| กระพริบ | Gripper อยู๋ในระหว่างการหยิบชิ้นงานขึ้นหรือปล่อยชิ้นงานลง  |

### ไฟแสดงสถานะ laser
  Laser แสดงสถานะการหยิบ / วางของ Gripper เช่นเดียวกับ D2 แต่จะทำงานเมื่อ Gripper หยิบ / วาง เสร็จแล้ว โดยจะใช้การกระพริบผสมระหว่าง กระพริบสั้นและยาว เพื่อบอกการหยิบ / วาง
| Laser | คำอธิบาย|
|-------|--------|
| สั้น สั้น ยาว | Gripper ได้จับชิ้นงานขึ้นมาแล้ว|
| ยาว สั้น สั้น | Gripper ได้วางชิ้นงานลงแล้ว|
| ติดค้าง  | อยู่ใน Test mode  |


### ปุ่ม Rst 
 ใช้ในการรีเซ็ตระบบของ End Effector ใหม่




## Mode of Operation
ระบบ End Effector มีโหมดการทำงานหลักทั้งสิ้น 4 โหมดเพื่อใช้ในการทดสอบและปรับแต่งตำแหน่งของ End Effector โดยอาศัยการดูสัญญาณจาก ไฟ LED จะสามารถระบุโหมดการทำงานปัจจุบันได้
### Idle mode (L กระพริบ 1 ครั้งสั้นๆ เป็นช่วงๆ)
เป็นโหมดการทำงานเริ่มต้นของระบบ End Effector จะยังไม่สามารถใช้งาน Gripper ในการหยิบจับสิ่งของได้
### Test mode (L กระพริบ 2 ครั้งสั้นๆ เป็นช่วงๆ)
เป็นโหมดการทำงานที่สามารถเปิด-ปิดได้ผ่าน I2C โดย Test Mode จะเปิดการทำงานของ Laser ค้าง เพื่อให้สามารถใช้ในการปรับตำแหน่งของหุ่นยนต์ / แขนกลในสนามโดยใช้ตำแหน่งของ Laser ในการอ้างอิง
### Run mode (L กระพริบ 1 ครั้งสั้นๆ เป็นช่วงๆ และ D1 ติดค้าง)
เป็นโหมดการทำงานที่สามารถเปิด-ปิดได้ผ่าน I2C สามารถใช้งาน Gripper ในการหยิบจับสิ่งของได้ ซึ่งเป็นโหมดที่จะต้องเปิดใช้งานเมื่อจะต้องใช้งาน Gripper
### Emergency mode (L กระพริบ 1 อย่างรวดเร็ว)
เป็นโหมดฉุกเฉินเพื่อใช้งานร่วมกับ Emergency Switch โดยสั่งคำสั่งผ่าน I2C โดยในโหมดนี้จะหยุดการทำงานปัจจุบันของ Gripper ทั้งหมดเพื่อจำลองในด้านการปลอดภัยของผู้ใช้งาน โหมดดังกล่าวควรได้รับคำสั่งการทำงานทันทีที่มีการกด Emergecy Switch หรือแขนกล/หุ่นยนต์ที่ End Effector ติดตั้งเข้าสู่โหมด Emergency

โหมดการทำงานนี้สามารถปิดได้ผ่านการใช้ I2C โดยใช้เขียนคำสั่งเฉพาะเพื่อออกจากโหมด Emergency เพื่อป้องกันการผิดพลาดอันเกิดจากสัญญาณรบกวนซึ่งส่งผลให้ออกจาก Emergency Mode ก่อนได้รับคำสั่งที่ถูกต้อง




## I2C Interface
 End effector ทำงานในโหมด I2C Slave โดยรองรับการทำงาน I2C ที่ความถี่ 100kHz โดยการติดต่อใดๆ กับ End Effector จะกระทำผ่าน Slave Address = 0x15 
 
 เนื่องจากระบบของ ARDUINO NANO ใช้แรงดัน 5V จึงต้องใช้ I2C ที่แรงดัน 5V โดยใช้ Resistor Pull Up ภายนอกขนาดขนาด 1k - 4.7k เข้ากับแรงดัน 5V ทั้งนี้ Nucleo สามารถใช้ Pull Up ดังกล่าวในการจ่ายสัญญาณ I2C ให้แก่ End Effector ได้
 
 แต่ละคำสั่งใน I2C ควรมีระยะห่างระหว่าง Stop ของคำสั่งที่แล้วและ Start ของคำสั่งปัจจุบันอย่างน้อย 10 ms
 
 
 
 ### คำสั่ง Soft Reset
 ในกรณีทั่วไปสามารถสั่ง Reset End Effector ได้ผ่านทาง I2C โดยใช้คำสั่ง
 
 |Start + Address + Write|seq1|seq2|seq3|seq4 + stop|
 |-----------------------|-----------|----------|----------|-----------------|
 |0x15 + W               |0x00|0xFF|0x55|0xAA|
 
 โดยเมื่อสิ้นสุดคำสั่งระบบจะ Reset ทันที และจะไม่สามารถรับคำสั่งต่อได้จนกว่าระบบจะ Reset เสร็จสิ้น
 
  ___________________________________________  
  
  
 ### คำสั่ง Emergency Mode
  เมื่อจำเป็นจะต้องเปิด Emergency Mode ในการหยุดการทำงานของ Gripper อย่างฉับพลันเพื่อความปลอดภัยของผู่ใช้งาน สามารถสั่งได้ผ่านคำสั่ง 
 
 |Start + Address + Write| emergency trigger + stop|
 |-----------------------|-----------|
 |0x15 + W               |0xFX|
 
 โดย 0xFX ค่าใดก็ได้ระหว่าง 0xF0 - 0xFF ระบบจะเข้าสู่ Emergency Mode ทันที (อาจจะมี Delay ที่ไฟแสดงสถานะ L เล็กน้อย แต่ระบบจะเข้า Emergency ทันทีที่ได้รับคำสั่ง)
 
 เมื่อต้องการออกจาก Emergency สามารถทำได้โดยการส่ง Sequence ปลดล็อกความปลอดภัยดังนี้ 
 
 |Start + Address + Write|seq1|seq2|seq3|seq4 + stop|
 |-----------------------|-----------|----------|----------|-----------------|
 |0x15 + W               |0xE5|0x7A|0xFF|0x81|
 
   ___________________________________________  

 
 ### คำสั่งเปิดการใช้งาน Test Mode
  การเปิด ปิด Test Mode เพื่อเปิดใช้งาน Laser ค้างเอาไว้ โดยสามารถใช้งานโหมดดังกล่าวได้ผ่าน I2C โดยใช้คำสั่ง
 
 |Start + Address + Write| test mode command| test mode on off + stop|
 |-----------------------|-----------|----------|
 |0x15 + W               |0x01|0xXX|
 
โดย **0xXX** จะเปิด Test Mode เมื่อเป็นค่าใดๆ ที่ไม่ใช่ 0 และ จะปิดการทำงานของ Test Mode เมื่อมีค่าเป็น 0
  ___________________________________________  

### คำสั่งการใช้งาน Gripper
เมื่อ End Effector ถูก Reset หรือเริ่มการทำงาน Gripper จะไม่อยู่ใน Run Mode และอยู่ในโหมด Idle เพื่อเป็นการสมมุติว่าประหยัดพลังงาน เพื่อให้ Gripper เข้าสู่ Run Mode ในการหยิบวางสิ่งของ จะต้องเปิดการทำงานของ Gripper และเข้าสู่ Run Mode โดยใช้คำสั่ง

 |Start + Address + Write| Run mode command| Run mode on + stop|
 |-----------------------|-----------|----------|
 |0x15 + W               |0x10|0x13|
 
 เมื่อ Gripper ทำงาน ไฟแสดงสถานะ D1 จะติดเพื่อแสดงสถานะ Run Mode และ Gripper สามารถหยิบ/วางสิ่งของได้
 
 ___________________________________________  
 
เพื่อปิดการทำงาน Run Mode เพื่อเข้าสู่โหมดประหยัดไฟ สามารถทำได้โดยการใช้คำสั่ง

 |Start + Address + Write| Run mode command| Run mode off + stop|
 |-----------------------|-----------|----------|
 |0x15 + W               |0x10|0x8C|
   
 ___________________________________________  
   
 ถ้าหาก Gripper อยู่ใน Run Mode จะสามารถสั่งงานให้ Gripper หยิบจับสิ่งของได้โดยใช้คำสั่ง
 |Start + Address + Write| Run mode command| Run mode Pick Up + stop|
 |-----------------------|-----------|----------|
 |0x15 + W               |0x10|0x5A|
 
 โดย Gripper จะใช้เวลาประมาณ 2 วินาที ในการทำงาน ไฟ D2 จะกระพริบแสดงการทำงานตลอดช่วงเวลาการหยิบ และเมื่อ Gripper หยิบชิ้นงานเรียบร้อย Laser จะยิงในจังหวะ สั้น สั้น ยาว เพื่อระบุตำแหน่งและเป็นการบอกว่า การหยิบได้เสร็จสิ้นแล้ว ไฟ D2 จะติดค้างเพื่อแสดงว่า Gripper กำลังจับสิ่งของอยู่
   
  ___________________________________________  
   
 ถ้าหาก Gripper อยู่ใน Run Mode จะสามารถสั่งงานให้ Gripper วางสิ่งของได้โดยใช้คำสั่ง
 |Start + Address + Write| Run mode command| Run mode place down + stop|
 |-----------------------|-----------|----------|
 |0x15 + W               |0x10|0x69|
 
 โดย gripper จะใช้เวลาประมาณ 2 วินาที ในการทำงาน ไฟ D2 จะกระพริบแสดงการทำงานตลอดช่วงเวลาการวาง และเมื่อ Gripper วางชิ้นงานเรียบร้อย Laser จะยิงในจังหวะ ยาว สั้น สั้น เพื่อระบุตำแหน่งและเป็นการบอกว่าการวางได้เสร็จสิ้นแล้ว ไฟ D2 จะดับเพื่อแสดงว่า Gripper ไม่ได้กำลังจับสิ่งของอยู่
     
_______________________________________

### การอ่านสถานะปัจจุบันของ End Effector 
สามารถอ่านได้โดยการใช้คำสั่ง 
  |Start + Address + Read| Device status + stop|
 |-----------------------|-----------|
 |0x15 + R               |0xXX|
 
 โดย 0xXX จะเป็นค่า Device Status  ขนาด  8 bits ซึ่งส่งกลับมาจาก End Effector โดยแต่ละบิตจะแทนสถานะดังต่อไปนี้
 Bit 7 - 5 : Error code (WIP)
 Bit 4     : Emergency mode (1 = on,0 = Off)
 Bit 3     : Test mode (1 = on,0 = Off)
 Bit 2     : Run mode (1 = on,0 = Off)
 Bit 1 - 0 : Gripper status (0b00 = Not pick , 0b01 = picking, 0b10 = placeing , 0b11 = picked )
 
## การ Update Software ให้กับ End Effector 
 การ Update Firmware ให้กับ End Effector ใดๆ จะต้องใช้กับ End Effector ที่ใช้ MCU ATMega328P เท่านั้น โดยทำการเชื่อมต่อ MCU ผ่าน USB Port 
 
 โดยการใช้งานผ่าน Xloader ตามขั้นตอนดังนี้
 1. แตกไฟล์ xloader.zip ให้เรียบร้อยและเปิดโปรแกรม xloader.exe
 2. เลือกไฟล์ fireware.hex ที่ถูกต้อง

![image](https://github.com/AlphaP2712/EndEffector2023/assets/74948675/dfd67d49-fc47-42b0-88dd-92b0661fa140) 
 
 3. เลือก Device เป็น Duemilanove/Nano(ATmega328)
 4. เลือก Com Port ให้ถูกต้อง
 5. กำหนด Baudrate เป็น 57600
 6. Upload
